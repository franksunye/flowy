name: ğŸ”„ Dependencies

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 9:00 æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ” ä¾èµ–æ£€æŸ¥
  dependency-check:
    name: ğŸ” Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ” Check for outdated packages
      run: |
        echo "## ğŸ“¦ Dependency Status Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥è¿‡æ—¶çš„åŒ…
        npm outdated --json > outdated.json 2>/dev/null || echo "{}" > outdated.json
        
        if [ "$(jq 'keys | length' outdated.json)" -gt "0" ]; then
          echo "### ğŸ”„ Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Current | Wanted | Latest |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' outdated.json >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… All Dependencies Up to Date" >> $GITHUB_STEP_SUMMARY
          echo "No outdated packages found!" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ›¡ï¸ Security audit
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ›¡ï¸ Security Audit" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œå®‰å…¨å®¡è®¡
        npm audit --json > audit.json 2>/dev/null || echo '{"vulnerabilities":{}}' > audit.json
        
        TOTAL_VULNS=$(jq '.vulnerabilities | keys | length' audit.json 2>/dev/null || echo "0")
        
        if [ "$TOTAL_VULNS" -gt "0" ]; then
          HIGH_VULNS=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length' audit.json)
          MODERATE_VULNS=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "moderate")) | length' audit.json)
          LOW_VULNS=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "low")) | length' audit.json)
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH_VULNS |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE_VULNS |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW_VULNS |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HIGH_VULNS" -gt "0" ]; then
            echo "::error::Found $HIGH_VULNS high severity vulnerabilities"
          fi
        else
          echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ“Š Dependency analysis
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Dependency Statistics" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡ä¾èµ–æ•°é‡
        PROD_DEPS=$(jq -r '.dependencies // {} | keys | length' package.json)
        DEV_DEPS=$(jq -r '.devDependencies // {} | keys | length' package.json)
        TOTAL_DEPS=$((PROD_DEPS + DEV_DEPS))
        
        echo "- **Production dependencies**: $PROD_DEPS" >> $GITHUB_STEP_SUMMARY
        echo "- **Development dependencies**: $DEV_DEPS" >> $GITHUB_STEP_SUMMARY
        echo "- **Total dependencies**: $TOTAL_DEPS" >> $GITHUB_STEP_SUMMARY
        
        # è®¡ç®— node_modules å¤§å°
        if [ -d "node_modules" ]; then
          NODE_MODULES_SIZE=$(du -sh node_modules | cut -f1)
          echo "- **node_modules size**: $NODE_MODULES_SIZE" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ’¾ Upload dependency reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          outdated.json
          audit.json
        retention-days: 30

  # ğŸ”„ è‡ªåŠ¨æ›´æ–°ä¾èµ– (å¯é€‰)
  auto-update:
    name: ğŸ”„ Auto Update Dependencies
    runs-on: ubuntu-latest
    needs: dependency-check
    if: false  # è®¾ç½®ä¸º true å¯ç”¨è‡ªåŠ¨æ›´æ–°
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ”„ Update dependencies
      run: |
        # æ›´æ–°è¡¥ä¸ç‰ˆæœ¬
        npm update
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet package-lock.json; then
          echo "No dependency updates available"
          echo "has_updates=false" >> $GITHUB_ENV
        else
          echo "Dependencies updated"
          echo "has_updates=true" >> $GITHUB_ENV
        fi
        
    - name: ğŸ§ª Test after update
      if: env.has_updates == 'true'
      run: |
        npm run test:unit
        npm run build
        
    - name: ğŸ“ Create Pull Request
      if: env.has_updates == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'ğŸ”„ chore: update dependencies'
        title: 'ğŸ”„ Automated dependency updates'
        body: |
          ## ğŸ”„ Automated Dependency Updates
          
          This PR contains automated dependency updates:
          
          ### Changes
          - Updated patch versions of dependencies
          - All tests pass after updates
          - Build verification completed
          
          ### Verification
          - âœ… Unit tests pass
          - âœ… Build succeeds
          - âœ… No breaking changes detected
          
          **Auto-generated by GitHub Actions**
        branch: chore/dependency-updates
        delete-branch: true

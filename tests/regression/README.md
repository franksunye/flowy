# 🧪 Flowy 回归测试套件

确保重构版本与原始版本功能完全一致的完整测试方案。

## 📋 测试概述

### 🎯 测试目标
- **功能一致性**: 确保重构版本与原始版本行为100%一致
- **回归检测**: 及时发现重构过程中引入的问题
- **质量保证**: 为持续重构提供信心保障

### 📂 测试范围
- **原始版本**: `docs/src-demo/index.html` (参考基准)
- **重构版本**: `docs/refactor-demo/index.html` (测试目标)

## 🚀 快速开始

### 1. 快速验证 (推荐)
```bash
npm run test:verify
```
**用途**: 快速检查核心功能是否一致
**时间**: ~30秒
**适用**: 日常开发验证

### 2. 完整回归测试
```bash
npm run test:regression
```
**用途**: 全面的功能对比测试
**时间**: ~2分钟
**适用**: 重要变更后的验证

### 3. 详细报告生成
```bash
npm run test:report
```
**用途**: 生成包含截图的详细HTML报告
**时间**: ~3分钟
**适用**: 问题调试和文档记录

## 📊 测试内容

### 🧪 核心功能测试

#### 1. 基本拖拽功能
- ✅ 从侧边栏拖拽块到画布
- ✅ 块的正确定位和显示
- ✅ DOM结构一致性

#### 2. 吸附功能 (关键测试)
- ✅ 第二个块吸附到第一个块
- ✅ 吸附位置精确度 (±5px误差)
- ✅ 连线自动生成

#### 3. 删除功能
- ✅ 单个块删除
- ✅ 级联删除相关连线
- ✅ 画布状态清理

#### 4. 删除后重新拖拽 (用户报告问题)
- ✅ 删除所有块后状态重置
- ✅ 重新拖拽第一个块
- ✅ 重新拖拽第二个块的吸附功能
- ✅ 连线重新生成

#### 5. 数据输出一致性
- ✅ `flowy.output()` 返回值对比
- ✅ 数据结构完整性
- ✅ 边界条件处理

### 🎯 高级测试

#### 6. 多块连接
- ✅ 三个或更多块的连接
- ✅ 复杂工作流的处理
- ✅ 连线路径计算

#### 7. 性能对比
- ✅ 操作响应时间
- ✅ 内存使用情况
- ✅ DOM操作效率

#### 8. 边界条件
- ✅ 空画布状态
- ✅ 重复操作
- ✅ 异常情况处理

## 📈 测试结果解读

### ✅ 成功指标
- **所有测试通过**: 功能完全一致
- **位置误差 < 5px**: 吸附精度符合要求
- **数据输出一致**: API行为相同

### ⚠️ 警告指标
- **轻微位置差异**: 可能的样式或计算差异
- **性能差异 > 20%**: 需要性能优化
- **控制台警告**: 潜在的兼容性问题

### ❌ 失败指标
- **功能缺失**: 重构版本缺少某些功能
- **行为不一致**: 相同操作产生不同结果
- **数据错误**: 输出数据结构不匹配

## 🔧 故障排除

### 常见问题

#### 1. 测试环境问题
```bash
# 确保Playwright已安装
npm install

# 如果浏览器未安装
npx playwright install chromium
```

#### 2. 页面加载失败
- 检查HTML文件路径是否正确
- 确保相关资源文件存在
- 验证JavaScript模块加载

#### 3. 吸附位置差异
- 检查CSS样式是否一致
- 验证JavaScript计算逻辑
- 确认事件处理时序

#### 4. 数据输出不一致
- 对比`flowy.output()`实现
- 检查数据同步逻辑
- 验证状态管理

### 调试技巧

#### 1. 启用详细日志
```javascript
// 在测试脚本中添加
console.log('调试信息:', debugData);
```

#### 2. 截图对比
```bash
# 生成详细报告查看截图
npm run test:report
# 查看 tests/regression/report.html
```

#### 3. 单步调试
```javascript
// 在测试中添加断点
await page.waitForTimeout(5000); // 暂停5秒观察
```

## 📁 文件结构

```
tests/regression/
├── README.md                 # 本文档
├── version-comparison.js     # 完整对比测试类
├── quick-verify.js          # 快速验证脚本
├── run-comparison.js        # 完整测试执行器
├── generate-report.js       # 详细报告生成器
├── screenshots/             # 测试截图目录
└── report.html             # 生成的HTML报告
```

## 🎯 最佳实践

### 开发流程
1. **每次重构前**: 运行 `npm run test:verify` 建立基准
2. **重构过程中**: 频繁运行快速验证
3. **重构完成后**: 运行完整回归测试
4. **发布前**: 生成详细报告存档

### 持续集成
```yaml
# GitHub Actions 示例
- name: 回归测试
  run: npm run test:verify
```

### 问题报告
当发现问题时：
1. 运行 `npm run test:report` 生成详细报告
2. 保存截图和错误日志
3. 记录重现步骤
4. 提交Issue时附上报告

## 🔄 更新维护

### 添加新测试
1. 在相应的测试类中添加新方法
2. 更新测试序列
3. 验证测试有效性

### 修改测试标准
1. 更新误差容忍度
2. 调整性能基准
3. 修改验证逻辑

---

**📞 需要帮助？**
- 查看项目文档: `docs/`
- 提交Issue: GitHub Issues
- 联系开发团队

# 11_SNAP_ENGINE_ANALYSIS.md - SnapEngine ä¸Ž Flowy.js å…³ç³»åˆ†æž

## ðŸ” å½“å‰çŠ¶æ€åˆ†æž

### ðŸ“Š æ¨¡å—çŠ¶æ€æ¦‚è§ˆ
- **SnapEngineæ¨¡å—**: âœ… **å·²å®Œæˆ** (238è¡Œï¼Œ19ä¸ªå•å…ƒæµ‹è¯•)
- **Flowy.jsé›†æˆ**: âŒ **æœªé›†æˆ** (ä»ä½¿ç”¨åŽŸå§‹å¸é™„é€»è¾‘)
- **æµ‹è¯•è¦†ç›–**: âœ… **100%** (ç‹¬ç«‹æµ‹è¯•é€šè¿‡)

## ðŸ—ï¸ æž¶æž„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    src/flowy.js (1,283è¡Œ)                   â”‚
â”‚                      ä¸»å…¥å£æ–‡ä»¶                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… å·²é›†æˆ: BlockManager (å—ç®¡ç†)                            â”‚
â”‚  âœ… å·²é›†æˆ: DomUtils (DOMå·¥å…·)                               â”‚
â”‚  âŒ æœªé›†æˆ: SnapEngine (å¸é™„å¼•æ“Ž)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              å½“å‰å¸é™„é€»è¾‘ (å†…è”å®žçŽ°)                          â”‚
â”‚  â€¢ è¡Œ 365-374: å¸é™„è¾¹ç•Œè®¡ç®—                                 â”‚
â”‚  â€¢ è¡Œ 302-317: blockSnap() è°ƒç”¨                             â”‚
â”‚  â€¢ è¡Œ 1245-1247: blockSnap() å‡½æ•°å®šä¹‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              src/core/snap-engine.js (238è¡Œ)                â”‚
â”‚                    ç‹¬ç«‹å¸é™„å¼•æ“Žæ¨¡å—                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… calculateSnapBounds()     - è¾¹ç•Œè®¡ç®—                     â”‚
â”‚  âœ… checkSnapRange()          - èŒƒå›´æ£€æµ‹                     â”‚
â”‚  âœ… detectSnapping()          - å¸é™„æ£€æµ‹                     â”‚
â”‚  âœ… calculateIndicatorPosition() - Indicatorä½ç½®             â”‚
â”‚  âœ… calculateSnapPosition()   - å¸é™„ä½ç½®è®¡ç®—                 â”‚
â”‚  âœ… triggerSnappingCallback() - å›žè°ƒè§¦å‘                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ”„ é›†æˆçŠ¶æ€è¯¦ç»†åˆ†æž

### 1. **æ¨¡å—åŠ è½½æœºåˆ¶** âŒ ç¼ºå¤±
å½“å‰ `src/flowy.js` ä¸­æ²¡æœ‰ SnapEngine çš„åŠ è½½é€»è¾‘ï¼š

```javascript
// å½“å‰åªæœ‰è¿™ä¸¤ä¸ªæ¨¡å—çš„åŠ è½½
function getBlockManager() { ... }
// ç¼ºå°‘: function getSnapEngine() { ... }
```

### 2. **å¸é™„é€»è¾‘å®žçŽ°** ðŸ”„ åŒé‡å®žçŽ°
- **åŽŸå§‹å®žçŽ°**: ç›´æŽ¥åœ¨ flowy.js ä¸­å†…è”è®¡ç®—
- **æ–°æ¨¡å—**: SnapEngine æä¾›çº¯å‡½æ•°å¼æŽ¥å£
- **çŠ¶æ€**: ä¸¤å¥—é€»è¾‘å¹¶å­˜ï¼Œæœªæ•´åˆ

### 3. **APIæŽ¥å£å¯¹æ¯”**

#### åŽŸå§‹å®žçŽ° (flowy.js å†…è”)
```javascript
// è¡Œ 365-374: å†…è”å¸é™„æ£€æµ‹
const xMin = targetBlock.x - targetBlock.width / 2 - paddingx;
const xMax = targetBlock.x + targetBlock.width / 2 + paddingx;
const yMin = targetBlock.y - targetBlock.height / 2;
const yMax = targetBlock.y + targetBlock.height;
const xInRange = xpos >= xMin && xpos <= xMax;
const yInRange = ypos >= yMin && ypos <= yMax;
```

#### SnapEngine æ¨¡å—æŽ¥å£
```javascript
// æ¨¡å—åŒ–æŽ¥å£
const bounds = snapEngine.calculateSnapBounds(targetBlock);
const snapResult = snapEngine.checkSnapRange(xpos, ypos, bounds);
const snapInfo = snapEngine.detectSnapping(xpos, ypos, blocks);
```

## ðŸŽ¯ é›†æˆè®¡åˆ’

### é˜¶æ®µ1: æ¨¡å—åŠ è½½é›†æˆ ðŸ“‹
```javascript
// éœ€è¦æ·»åŠ åˆ° flowy.js
function getSnapEngine() {
  if (typeof window !== 'undefined' && window.SnapEngine) {
    return new window.SnapEngine(spacing_x, spacing_y, snapping);
  }
  if (typeof require !== 'undefined') {
    try {
      const SnapEngine = require('./core/snap-engine.js');
      return new SnapEngine(spacing_x, spacing_y, snapping);
    } catch (e) {
      return null;
    }
  }
  return null;
}
```

### é˜¶æ®µ2: å¸é™„é€»è¾‘æ›¿æ¢ ðŸ“‹
æ›¿æ¢ flowy.js ä¸­çš„å†…è”å¸é™„è®¡ç®—ï¼š
- è¡Œ 365-374: ä½¿ç”¨ `snapEngine.detectSnapping()`
- è¡Œ 302-317: ä½¿ç”¨ `snapEngine.calculateSnapPosition()`
- è¡Œ 1245-1247: ä½¿ç”¨ `snapEngine.triggerSnappingCallback()`

### é˜¶æ®µ3: Indicatorç®¡ç†é›†æˆ ðŸ“‹
- ä½¿ç”¨ SnapEngine çš„ indicator ä½ç½®è®¡ç®—
- é›†æˆå¯è§æ€§çŠ¶æ€ç®¡ç†
- ç»Ÿä¸€ indicator ç”Ÿå‘½å‘¨æœŸ

## ðŸ§ª æµ‹è¯•ç­–ç•¥

### å½“å‰æµ‹è¯•çŠ¶æ€
- **SnapEngineç‹¬ç«‹æµ‹è¯•**: âœ… 19ä¸ªæµ‹è¯•ï¼Œ100%é€šè¿‡
- **Flowy.jså¸é™„æµ‹è¯•**: âœ… 16ä¸ªæµ‹è¯•ï¼Œä½¿ç”¨åŽŸå§‹é€»è¾‘
- **é›†æˆæµ‹è¯•**: âŒ å°šæœªåˆ›å»º

### é›†æˆæµ‹è¯•è®¡åˆ’
1. **å‘åŽå…¼å®¹æµ‹è¯•**: ç¡®ä¿APIè¡Œä¸ºä¸€è‡´
2. **æ€§èƒ½å›žå½’æµ‹è¯•**: éªŒè¯å¸é™„æ€§èƒ½æ— ä¸‹é™
3. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**: éªŒè¯è¾¹ç¼˜æƒ…å†µå¤„ç†
4. **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´å·¥ä½œæµéªŒè¯

## ðŸ“‹ å¾…åŠžäº‹é¡¹

### é«˜ä¼˜å…ˆçº§ ðŸ”¥
- [ ] **æ·»åŠ SnapEngineæ¨¡å—åŠ è½½é€»è¾‘**
- [ ] **æ›¿æ¢å†…è”å¸é™„è®¡ç®—ä¸ºæ¨¡å—è°ƒç”¨**
- [ ] **æ›´æ–°index.htmlå¯¼å…¥SnapEngine**
- [ ] **åˆ›å»ºé›†æˆæµ‹è¯•å¥—ä»¶**

### ä¸­ä¼˜å…ˆçº§ ðŸš€
- [ ] **ä¼˜åŒ–indicatorç®¡ç†é€»è¾‘**
- [ ] **ç»Ÿä¸€å›žè°ƒå‡½æ•°å¤„ç†**
- [ ] **æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•**

### ä½Žä¼˜å…ˆçº§ ðŸ“š
- [ ] **æ›´æ–°APIæ–‡æ¡£**
- [ ] **æ·»åŠ ä½¿ç”¨ç¤ºä¾‹**
- [ ] **åˆ›å»ºè¿ç§»æŒ‡å—**

## ðŸŽ¯ é¢„æœŸæ”¶ç›Š

### ä»£ç è´¨é‡æå‡
- **å¯æµ‹è¯•æ€§**: å¸é™„é€»è¾‘ç‹¬ç«‹æµ‹è¯•
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–æž¶æž„
- **å¯å¤ç”¨æ€§**: çº¯å‡½æ•°å¼æŽ¥å£

### æ€§èƒ½ä¼˜åŒ–æ½œåŠ›
- **è®¡ç®—ä¼˜åŒ–**: ä¸“é—¨çš„ç®—æ³•å®žçŽ°
- **å†…å­˜ç®¡ç†**: çŠ¶æ€é›†ä¸­ç®¡ç†
- **ç¼“å­˜æœºåˆ¶**: è¾¹ç•Œè®¡ç®—ç¼“å­˜

---

**çŠ¶æ€**: åˆ†æžå®Œæˆï¼Œç­‰å¾…é›†æˆå®žæ–½  
**è´Ÿè´£äºº**: é‡æž„å›¢é˜Ÿ  
**æœ€åŽæ›´æ–°**: 2025-07-22

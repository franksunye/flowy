# 00_BACKLOG.md - Flowy 产品待办事项

## 🎯 当前Sprint目标
**Sprint 2**: 完成模块化重构，建立现代化架构基础

## 📋 产品待办事项 (Product Backlog)

### 🔥 高优先级 (High Priority)

#### 测试基础设施 ✅ 已完成
- [x] **建立单元测试框架** - 完成Jest测试环境配置
- [x] **创建隔离测试环境** - 解决测试间依赖问题
- [x] **达到100%测试通过率** - 83个测试全部通过
- [x] **添加代码覆盖率报告** - 集成Jest coverage
- [x] **建立CI/CD流水线** - GitHub Actions自动化测试

#### 测试覆盖增强 ✅ 已完成 (高优先级)
- [x] **状态清理测试** - 测试删除所有块后重新拖拽的完整流程
- [x] **吸附功能回归测试** - 专门测试吸附功能在各种状态下的正确性
- [x] **边界条件测试** - 测试空画布、单块、多块删除等边界情况
- [x] **状态一致性测试** - 验证内部状态与UI状态的一致性
- [x] **关键Bug复现测试** - 成功复现用户报告的吸附功能失效问题
- [x] **测试覆盖分析报告** - 详细的问题分析和修复建议

#### 紧急Bug修复 🔥 已确认 (最高优先级)

##### 🚨 关键功能缺陷 (P0 - 阻塞性问题) - 通过测试覆盖发现
- [ ] **BUG-001: 拖拽功能完全失效** ✅ 已确认
  - 问题: `flowy.output()` 返回 `undefined`，拖拽操作无法创建块
  - 影响: 核心功能不可用，阻塞所有工作流创建
  - 测试证据: 34个新测试失败，涉及所有拖拽相关功能
  - 发现方式: 基于源代码分析的测试覆盖改进
  - 优先级: P0 (最高)

- [ ] **BUG-002: 吸附功能完全失效** ✅ 已确认
  - 问题: indicator从未显示，吸附检测不工作
  - 影响: 无法创建块之间的连接关系
  - 测试证据: 所有吸附相关测试失败，indicator数量始终为0
  - 发现方式: 吸附功能完整性测试
  - 优先级: P0 (最高)

- [ ] **BUG-007: 事件处理机制失效** ✅ 新发现
  - 问题: 回调函数未被正确调用，事件链中断
  - 影响: 用户交互反馈缺失，拖拽状态管理异常
  - 测试证据: 事件处理完整性测试失败
  - 发现方式: 事件处理完整性测试
  - 优先级: P0 (最高)

##### 🔧 状态管理问题 (P1 - 高优先级)
- [ ] **BUG-003: 状态清理不彻底**
  - 问题: `flowy.deleteBlocks()` 未正确重置内部状态变量
  - 影响: 删除后重新操作时状态不一致
  - 相关变量: `active`, `rearrange`, `drag`, `original`
  - 优先级: P1

- [ ] **BUG-004: 模块状态同步问题**
  - 问题: BlockManager与主实例状态不同步
  - 影响: 模块化重构中的数据一致性问题
  - 测试: 状态一致性测试失败
  - 优先级: P1

##### 🎯 DOM和事件处理问题 (P2 - 中优先级)
- [ ] **BUG-005: DOM状态与数据不一致**
  - 问题: 内部数据与DOM元素状态不匹配
  - 影响: 界面显示与实际数据不符
  - 测试: DOM一致性测试失败
  - 优先级: P2

- [ ] **BUG-006: 事件监听器失效**
  - 问题: 回调函数未被正确调用
  - 影响: 拖拽事件处理异常
  - 测试: 事件处理测试失败
  - 优先级: P2

#### 开发环境现代化 ✅ 已完成
- [x] **建立现代化构建系统** - Vite构建系统配置完成
- [x] **添加代码质量工具** - ESLint + Prettier
- [x] **建立开发服务器** - Vite热更新开发环境
- [x] **优化开发工作流** - 自动化任务和脚本

#### 模块化重构 🔄 进行中 (50% 完成)
- [x] **DOM工具模块** (`src/utils/dom-utils.js`) - 封装jQuery操作接口
- [x] **块管理模块** (`src/core/block-manager.js`) - 提取blocks数组管理逻辑
- [x] **吸附引擎模块** (`src/core/snap-engine.js`) - ⚠️ **模块已完成，待集成**
  - ✅ 238行纯函数式吸附算法实现
  - ✅ 19个单元测试，100%通过率
  - ❌ 尚未集成到主文件 (src/flowy.js)
- [ ] **拖拽处理模块** (`src/core/drag-handler.js`) - 提取鼠标事件处理逻辑
- [ ] **API模块重构** (`src/api/`) - 重构output和deleteBlocks方法
- [ ] **主入口重构** - 集成所有模块，保持API兼容

**重构原则**: 向后兼容 | 测试驱动 | 渐进式 | 零功能影响
**验证标准**: 83/83测试通过 | API完全兼容 | 性能无回归

### 🚀 中优先级 (Medium Priority)

#### ES6+语法现代化 📋 计划中
- [ ] **var → const/let转换** - 现代变量声明
- [ ] **函数表达式 → 箭头函数** - 简化函数语法
- [ ] **字符串拼接 → 模板字符串** - 提高可读性
- [ ] **Promise/async-await** - 现代异步处理
- [ ] **解构赋值** - 简化对象和数组操作

#### jQuery依赖移除 📋 计划中
- [ ] **DOM选择器替换** - 使用原生querySelector
- [ ] **事件处理替换** - 使用原生addEventListener
- [ ] **CSS操作替换** - 使用原生style和classList
- [ ] **动画替换** - 使用CSS transitions或Web Animations API
- [ ] **AJAX替换** - 使用fetch API

#### 性能优化 📋 计划中
- [x] **建立性能基准测试** - 性能回归检测已建立
- [ ] **优化拖拽性能** - 减少DOM操作频率
- [ ] **内存使用优化** - 避免内存泄漏
- [ ] **渲染性能优化** - 60fps流畅体验
- [ ] **Bundle大小优化** - Tree shaking和代码分割

### 📚 低优先级 (Low Priority)

#### TypeScript支持
- [ ] **添加TypeScript配置** - 渐进式类型化
- [ ] **核心模块类型定义** - 主要API类型
- [ ] **严格类型检查** - 类型安全保证
- [ ] **生成类型声明文件** - 外部使用支持

#### 文档和示例
- [ ] **完善API文档** - 详细的API参考
- [ ] **创建使用示例** - 多种使用场景
- [ ] **编写最佳实践指南** - 开发建议
- [ ] **创建贡献指南** - 开源贡献流程

#### 工作流持久化功能 📋 计划中
- [ ] **数据导入功能** (`flowy.import(data)`) - 从JSON数据重建工作流
- [ ] **状态完整恢复** - 恢复块位置、连接线、样式等完整状态
- [ ] **内置保存/加载** (`flowy.save()` / `flowy.load()`) - 简化持久化操作
- [ ] **浏览器存储集成** - localStorage/sessionStorage自动保存
- [ ] **文件格式支持** - 支持多种导出格式 (JSON, XML, CSV)
- [ ] **版本控制** - 工作流版本管理和历史记录

#### 高级功能
- [ ] **添加撤销/重做功能** - 用户体验提升
- [ ] **支持键盘快捷键** - 提高操作效率
- [ ] **添加主题系统** - 可定制外观
- [ ] **支持插件系统** - 扩展性增强

## 🏃‍♂️ 当前Sprint (Sprint 2)

### Sprint目标
完成模块化重构的核心阶段，建立稳定的模块化架构

### Sprint待办事项
- [x] DOM工具模块提取和验证
- [x] 块管理模块提取和验证
- [x] 吸附引擎模块提取 ⚠️ **待集成**
- [ ] **SnapEngine集成到flowy.js** - 🔥 **当前优先级**
- [ ] 拖拽处理模块提取
- [ ] API模块重构
- [ ] 主入口文件重构
- [ ] 完整的端到端测试验证
- [ ] 性能回归测试
- [ ] 文档更新

### 完成标准 (Definition of Done)
- [x] 所有83个单元测试通过
- [x] 代码覆盖率保持稳定
- [x] CI/CD流水线正常运行
- [ ] 模块化重构100%完成
- [ ] 端到端测试通过
- [ ] 性能无回归
- [ ] 文档更新完成
- [ ] 代码审查通过

## 📊 进度跟踪

### 已完成 (Completed) ✅
- ✅ Jest测试框架配置
- ✅ 隔离测试环境开发
- ✅ 83个单元测试编写
- ✅ 100%测试通过率达成
- ✅ 测试文档编写
- ✅ 项目文档结构建立
- ✅ 代码覆盖率报告集成
- ✅ CI/CD流水线建立 (GitHub Actions)
- ✅ 现代化构建系统 (Vite)
- ✅ 开发服务器建立
- ✅ 代码质量工具 (ESLint + Prettier)
- ✅ DOM工具模块提取 (src/utils/dom-utils.js)
- ✅ 块管理模块提取 (src/core/block-manager.js)
- ✅ 模块化目录结构建立
- ✅ 开发环境模块集成

### 进行中 (In Progress) 🔄
- 🔄 **SnapEngine集成** - 模块已完成，正在集成到主文件
- 🔄 文档现代化更新

### 待开始 (To Do) ⏳
- ⏳ 拖拽处理模块提取
- ⏳ API模块重构
- ⏳ 主入口文件重构
- ⏳ ES6+语法现代化
- ⏳ jQuery依赖移除

## 🎯 里程碑 (Milestones)

### 里程碑1: 测试基础 ✅ (已完成)
- ✅ 建立完整的测试套件 (83个单元测试)
- ✅ 达到100%测试通过率
- ✅ 创建隔离测试环境
- ✅ 集成代码覆盖率报告

### 里程碑2: 开发环境 ✅ (已完成)
- ✅ 现代化构建系统 (Vite)
- ✅ CI/CD自动化 (GitHub Actions)
- ✅ 代码质量工具 (ESLint + Prettier)
- ✅ 开发服务器和热更新

### 里程碑3: 模块化重构 🔄 (进行中 - 50%)
- ✅ DOM工具模块 (已完成)
- ✅ 块管理模块 (已完成)
- ✅ 吸附引擎模块 (已完成) ⚠️ **待集成**
- ⏳ 拖拽处理模块 (计划中)
- ⏳ API模块重构 (计划中)

### 里程碑4: 语法现代化 📋 (计划中)
- ⏳ ES6+语法转换
- ⏳ 移除jQuery依赖
- ⏳ 现代异步处理

### 里程碑5: TypeScript支持 📋 (计划中)
- ⏳ 类型定义文件
- ⏳ 渐进式类型检查
- ⏳ 类型声明文件生成

## 🔄 敏捷实践

### Scrum活动
- **Sprint计划**: 每2周进行Sprint规划
- **每日站会**: 跟踪进度和阻碍
- **Sprint评审**: 展示完成的功能
- **Sprint回顾**: 改进流程和实践

### 估算方法
- **故事点**: 使用斐波那契数列 (1, 2, 3, 5, 8, 13)
- **时间盒**: 每个任务不超过1天
- **风险评估**: 高/中/低风险分类

---

**产品负责人**: Flowy团队  
**Scrum Master**: 开发团队  
**最后更新**: 2025-07-18

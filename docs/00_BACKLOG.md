# 00_BACKLOG.md - Flowy 产品待办事项

## 🎯 当前Sprint目标
**Sprint 3**: 修复核心功能缺陷，完成模块化重构集成

## 📋 产品待办事项 (Product Backlog)

### 🚨 紧急任务 (Critical Priority) - 2025-07-22

#### 高级测试修复 🔥 (P0 - 阻塞性问题)
- [ ] **修复位置计算算法测试** (7个失败)
  - 问题: flowy.output()返回undefined，无法验证位置计算
  - 影响: 位置计算和边界检查算法无法验证
  - 优先级: P0

- [ ] **修复事件处理完整性测试** (3个失败)
  - 问题: 回调函数未被调用，事件链中断
  - 影响: 拖拽交互功能验证失败
  - 优先级: P0

- [ ] **修复重排算法测试** (5个失败)
  - 问题: 块创建失败，无法测试重排逻辑
  - 影响: 复杂布局算法无法验证
  - 优先级: P0

- [ ] **修复状态一致性测试** (7个失败)
  - 问题: DOM与数据状态不一致
  - 影响: 数据完整性无法保证
  - 优先级: P0

**根本原因分析**: 高级测试依赖完整的拖拽功能，但当前实现中存在基础功能缺陷
**修复策略**: 优先修复基础拖拽功能，然后逐步修复高级测试

### 🔥 高优先级 (High Priority)

#### 测试基础设施 ✅ 已完成
- [x] **建立单元测试框架** - 完成Jest测试环境配置
- [x] **创建隔离测试环境** - 解决测试间依赖问题
- [x] **达到100%测试通过率** - 83个测试全部通过
- [x] **添加代码覆盖率报告** - 集成Jest coverage
- [x] **建立CI/CD流水线** - GitHub Actions自动化测试

#### 测试覆盖增强 ✅ 已完成 (高优先级)
- [x] **状态清理测试** - 测试删除所有块后重新拖拽的完整流程
- [x] **吸附功能回归测试** - 专门测试吸附功能在各种状态下的正确性
- [x] **边界条件测试** - 测试空画布、单块、多块删除等边界情况
- [x] **状态一致性测试** - 验证内部状态与UI状态的一致性
- [x] **关键Bug复现测试** - 成功复现用户报告的吸附功能失效问题
- [x] **测试覆盖分析报告** - 详细的问题分析和修复建议

#### 紧急Bug修复 🔥 已确认 (最高优先级)

##### 🚨 关键功能缺陷 (P0 - 阻塞性问题) - 2025-07-22 最新状态
- [x] **BUG-001: 拖拽功能完全失效** ✅ 已修复
  - 问题: `flowy.output()` 返回 `undefined`，拖拽操作无法创建块
  - 根本原因: clearAllBlocks()调用错误方法，未正确清理blockstemp数组
  - 修复方案: 使用blockManager.clearAll()并添加syncBlockReferences()调用
  - 验证结果: 回归测试通过，功能与原始版本100%一致
  - 状态: ✅ 已完成 (2025-07-22)

- [x] **BUG-002: 吸附功能完全失效** ✅ 已修复
  - 问题: indicator从未显示，吸附检测不工作
  - 根本原因: 同BUG-001，数据同步问题导致吸附检测失败
  - 修复方案: 修复数据同步后，吸附功能自动恢复
  - 验证结果: 删除后重新拖拽吸附功能正常工作
  - 状态: ✅ 已完成 (2025-07-22)

- [ ] **BUG-008: 模块集成不完整** 🔥 新发现 (P0)
  - 问题: SnapEngine模块已创建但未真正集成到主文件
  - 影响: 重构版本仍使用原始内联逻辑，模块化未生效
  - 测试证据: 34个高级测试失败，flowy.output()返回undefined
  - 根本原因: 模块创建完成但缺少集成步骤
  - 状态: 🔄 部分完成 - SnapEngine已集成，但仍有测试失败
  - 优先级: P0 (最高)

##### 🔧 状态管理问题 (P1 - 高优先级)
- [ ] **BUG-003: 状态清理不彻底**
  - 问题: `flowy.deleteBlocks()` 未正确重置内部状态变量
  - 影响: 删除后重新操作时状态不一致
  - 相关变量: `active`, `rearrange`, `drag`, `original`
  - 优先级: P1

- [ ] **BUG-004: 模块状态同步问题**
  - 问题: BlockManager与主实例状态不同步
  - 影响: 模块化重构中的数据一致性问题
  - 测试: 状态一致性测试失败
  - 优先级: P1

##### 🎯 DOM和事件处理问题 (P2 - 中优先级)
- [ ] **BUG-005: DOM状态与数据不一致**
  - 问题: 内部数据与DOM元素状态不匹配
  - 影响: 界面显示与实际数据不符
  - 测试: DOM一致性测试失败
  - 优先级: P2

- [ ] **BUG-006: 事件监听器失效**
  - 问题: 回调函数未被正确调用
  - 影响: 拖拽事件处理异常
  - 测试: 事件处理测试失败
  - 优先级: P2

#### 开发环境现代化 ✅ 已完成
- [x] **建立现代化构建系统** - Vite构建系统配置完成
- [x] **添加代码质量工具** - ESLint + Prettier
- [x] **建立开发服务器** - Vite热更新开发环境
- [x] **优化开发工作流** - 自动化任务和脚本

#### 模块化重构 🔄 进行中 (67% 完成)
- [x] **DOM工具模块** (`src/utils/dom-utils.js`) - ⚠️ 已创建，未集成
  - ✅ 278行jQuery操作封装
  - ❌ 主文件中仍直接使用jQuery，未使用此模块
- [x] **块管理模块** (`src/core/block-manager.js`) - ✅ 已完成并集成
  - ✅ 260行数据管理逻辑
  - ✅ 已集成到主文件，正常工作
- [x] **吸附引擎模块** (`src/core/snap-engine.js`) - ✅ 已完成并集成
  - ✅ 238行纯函数式吸附算法实现
  - ✅ 19个单元测试，100%通过率
  - ✅ 已集成到主文件 (2025-07-22)
  - ✅ 回归测试通过，功能正常
- [ ] **拖拽处理模块** (`src/core/drag-handler.js`) - 📋 计划中
- [ ] **API模块重构** (`src/api/`) - 📋 计划中

**当前状态**: 2/3核心模块已真正集成，1个模块待集成
**重构原则**: 向后兼容 | 测试驱动 | 渐进式 | 零功能影响
**验证标准**: 117/151测试通过 | 34个高级测试待修复

### 🚀 中优先级 (Medium Priority)

#### ES6+语法现代化 📋 计划中
- [ ] **var → const/let转换** - 现代变量声明
- [ ] **函数表达式 → 箭头函数** - 简化函数语法
- [ ] **字符串拼接 → 模板字符串** - 提高可读性
- [ ] **Promise/async-await** - 现代异步处理
- [ ] **解构赋值** - 简化对象和数组操作

#### jQuery依赖移除 📋 计划中
- [ ] **DOM选择器替换** - 使用原生querySelector
- [ ] **事件处理替换** - 使用原生addEventListener
- [ ] **CSS操作替换** - 使用原生style和classList
- [ ] **动画替换** - 使用CSS transitions或Web Animations API
- [ ] **AJAX替换** - 使用fetch API

#### 性能优化 📋 计划中
- [x] **建立性能基准测试** - 性能回归检测已建立
- [ ] **优化拖拽性能** - 减少DOM操作频率
- [ ] **内存使用优化** - 避免内存泄漏
- [ ] **渲染性能优化** - 60fps流畅体验
- [ ] **Bundle大小优化** - Tree shaking和代码分割

### 📚 低优先级 (Low Priority)

#### TypeScript支持
- [ ] **添加TypeScript配置** - 渐进式类型化
- [ ] **核心模块类型定义** - 主要API类型
- [ ] **严格类型检查** - 类型安全保证
- [ ] **生成类型声明文件** - 外部使用支持

#### 文档和示例
- [ ] **完善API文档** - 详细的API参考
- [ ] **创建使用示例** - 多种使用场景
- [ ] **编写最佳实践指南** - 开发建议
- [ ] **创建贡献指南** - 开源贡献流程

#### 工作流持久化功能 📋 计划中
- [ ] **数据导入功能** (`flowy.import(data)`) - 从JSON数据重建工作流
- [ ] **状态完整恢复** - 恢复块位置、连接线、样式等完整状态
- [ ] **内置保存/加载** (`flowy.save()` / `flowy.load()`) - 简化持久化操作
- [ ] **浏览器存储集成** - localStorage/sessionStorage自动保存
- [ ] **文件格式支持** - 支持多种导出格式 (JSON, XML, CSV)
- [ ] **版本控制** - 工作流版本管理和历史记录

#### 高级功能
- [ ] **添加撤销/重做功能** - 用户体验提升
- [ ] **支持键盘快捷键** - 提高操作效率
- [ ] **添加主题系统** - 可定制外观
- [ ] **支持插件系统** - 扩展性增强

## 🏃‍♂️ 当前Sprint (Sprint 3)

### Sprint目标
修复高级测试失败问题，完成真正的模块化集成

### Sprint待办事项 (按优先级排序)
- [x] SnapEngine集成到flowy.js ✅ 已完成 (2025-07-22)
- [x] 核心吸附功能修复 ✅ 已完成 (2025-07-22)
- [ ] **修复34个失败的高级测试** 🔥 **当前最高优先级**
  - 位置计算算法测试 (7个失败)
  - 事件处理完整性测试 (3个失败)
  - 重排算法测试 (5个失败)
  - 状态一致性测试 (7个失败)
  - 吸附功能完整性测试 (6个失败)
  - 状态清理回归测试 (3个失败)
  - 关键Bug复现测试 (2个失败)
- [ ] DomUtils模块集成 (可选)
- [ ] 拖拽处理模块提取
- [ ] 完整的端到端测试验证

### 完成标准 (Definition of Done)
- [x] 基础单元测试通过 (117/151)
- [x] 核心功能回归测试通过 ✅
- [x] CI/CD流水线正常运行
- [ ] **所有151个测试通过** 🔥 **当前阻塞点**
- [ ] 模块化重构100%完成 (当前67%)
- [ ] 端到端测试通过
- [ ] 性能无回归
- [ ] 文档更新完成

## 📊 进度跟踪

### 已完成 (Completed) ✅
- ✅ Jest测试框架配置
- ✅ 隔离测试环境开发
- ✅ 83个单元测试编写
- ✅ 100%测试通过率达成
- ✅ 测试文档编写
- ✅ 项目文档结构建立
- ✅ 代码覆盖率报告集成
- ✅ CI/CD流水线建立 (GitHub Actions)
- ✅ 现代化构建系统 (Vite)
- ✅ 开发服务器建立
- ✅ 代码质量工具 (ESLint + Prettier)
- ✅ DOM工具模块提取 (src/utils/dom-utils.js)
- ✅ 块管理模块提取 (src/core/block-manager.js)
- ✅ 模块化目录结构建立
- ✅ 开发环境模块集成

### 进行中 (In Progress) 🔄
- 🔄 **高级测试修复** - 34个测试失败，需要深度调试
- 🔄 模块化集成完善 - DomUtils模块待集成
- 🔄 文档现代化更新

### 待开始 (To Do) ⏳
- ⏳ 拖拽处理模块提取 (依赖测试修复完成)
- ⏳ API模块重构
- ⏳ 主入口文件重构
- ⏳ ES6+语法现代化
- ⏳ jQuery依赖移除

## 🎯 里程碑 (Milestones)

### 里程碑1: 测试基础 ✅ (已完成)
- ✅ 建立完整的测试套件 (83个单元测试)
- ✅ 达到100%测试通过率
- ✅ 创建隔离测试环境
- ✅ 集成代码覆盖率报告

### 里程碑2: 开发环境 ✅ (已完成)
- ✅ 现代化构建系统 (Vite)
- ✅ CI/CD自动化 (GitHub Actions)
- ✅ 代码质量工具 (ESLint + Prettier)
- ✅ 开发服务器和热更新

### 里程碑3: 模块化重构 🔄 (进行中 - 67%)
- ⚠️ DOM工具模块 (已创建，未集成)
- ✅ 块管理模块 (已完成并集成)
- ✅ 吸附引擎模块 (已完成并集成) ✅ **2025-07-22完成**
- ⏳ 拖拽处理模块 (计划中)
- ⏳ API模块重构 (计划中)

### 里程碑4: 语法现代化 📋 (计划中)
- ⏳ ES6+语法转换
- ⏳ 移除jQuery依赖
- ⏳ 现代异步处理

### 里程碑5: TypeScript支持 📋 (计划中)
- ⏳ 类型定义文件
- ⏳ 渐进式类型检查
- ⏳ 类型声明文件生成

## 🔄 敏捷实践

### Scrum活动
- **Sprint计划**: 每2周进行Sprint规划
- **每日站会**: 跟踪进度和阻碍
- **Sprint评审**: 展示完成的功能
- **Sprint回顾**: 改进流程和实践

### 估算方法
- **故事点**: 使用斐波那契数列 (1, 2, 3, 5, 8, 13)
- **时间盒**: 每个任务不超过1天
- **风险评估**: 高/中/低风险分类

---

**产品负责人**: Flowy团队
**Scrum Master**: 开发团队
**最后更新**: 2025-07-22

---

## 📊 当前状态总结 (2025-07-22)

### ✅ 重大成就
- **核心Bug修复**: 删除后重新拖拽吸附功能失效问题已完全解决
- **模块化进展**: 2/3核心模块已真正集成 (BlockManager + SnapEngine)
- **回归测试体系**: 建立完整的功能一致性验证体系
- **质量保证**: 基础功能与原始版本100%一致

### 🚨 当前挑战
- **测试覆盖**: 34/151个高级测试失败，需要深度调试
- **模块集成**: DomUtils模块已创建但未集成
- **功能验证**: 高级功能测试依赖基础功能完善

### 🎯 下一步重点
1. **修复高级测试** - 解决34个失败测试，恢复完整测试覆盖
2. **完成模块集成** - 集成DomUtils或重新评估其必要性
3. **继续模块化** - 拖拽处理模块提取

# REFACTORING_PLAN.md - Flowy 模块化重构计划

## 🎯 重构目标

将单体 `flowy.js` 文件重构为模块化架构，同时保证：
- ✅ **功能完全一致** - 所有现有功能保持不变
- ✅ **API兼容性** - 对外API保持完全兼容
- ✅ **测试通过率100%** - 所有83个测试继续通过
- ✅ **性能不降级** - 性能保持或提升

## 📋 重构策略

### 测试驱动重构 (TDD)
1. **测试先行** - 每个模块提取前后都要验证测试通过
2. **渐进式重构** - 一次只重构一个模块
3. **回滚机制** - 如果测试失败，立即回滚到上一个稳定状态

### 模块化原则
- **单一职责** - 每个模块只负责一个核心功能
- **低耦合** - 模块间依赖最小化
- **高内聚** - 相关功能聚合在同一模块
- **接口稳定** - 模块对外接口保持稳定

## 🏗️ 目标架构

```
src/
├── flowy.js                 # 主入口文件
├── core/
│   ├── drag-handler.js      # 拖拽处理模块
│   ├── snap-engine.js       # 吸附引擎模块
│   └── block-manager.js     # 块管理模块
├── utils/
│   └── dom-utils.js         # DOM工具模块
└── api/
    ├── output.js            # 数据输出API
    └── cleanup.js           # 清理功能API
```

## 📝 详细重构步骤

### 阶段1: 准备工作 (1-2小时)

#### 1.1 建立基准测试
```bash
# 运行完整测试套件，记录基准
npm run test:coverage
npm run test:e2e

# 记录性能基准
npm run test:performance
```

#### 1.2 创建模块目录结构
```bash
mkdir -p src/core src/utils src/api
```

#### 1.3 配置构建系统
- 更新 `vite.config.js` 支持模块化构建
- 确保开发和生产环境都能正确处理模块

### 阶段2: 模块提取 (按依赖顺序)

#### 2.1 DOM工具模块 (`src/utils/dom-utils.js`) ✅ 已完成
**提取内容**:
- ✅ jQuery操作封装
- ✅ DOM元素创建和操作
- ✅ 样式和属性操作

**测试验证**:
```bash
npm run test:unit
# ✅ 83/83 测试通过
```

**完成时间**: 2025-07-21
**验证结果**:
- ✅ 所有单元测试通过 (83/83)
- ✅ 代码覆盖率稳定
- ✅ 开发服务器正常
- ✅ API完全兼容

#### 2.2 块管理模块 (`src/core/block-manager.js`)
**提取内容**:
- `blocks` 数组管理
- 块的创建、删除、查找
- 块的位置和尺寸计算

**依赖**: `dom-utils.js`

#### 2.3 吸附引擎模块 (`src/core/snap-engine.js`)
**提取内容**:
- 吸附位置计算
- `indicator` 元素管理
- 吸附检测逻辑

**依赖**: `block-manager.js`, `dom-utils.js`

#### 2.4 拖拽处理模块 (`src/core/drag-handler.js`)
**提取内容**:
- 鼠标事件处理
- 拖拽状态管理
- 拖拽过程中的位置更新

**依赖**: `snap-engine.js`, `block-manager.js`, `dom-utils.js`

#### 2.5 API模块 (`src/api/`)
**提取内容**:
- `flowy.output()` 实现
- `flowy.deleteBlocks()` 实现

**依赖**: `block-manager.js`

### 阶段3: 主入口重构 (`src/flowy.js`)

将主文件重构为模块协调器：
```javascript
// 导入所有模块
import DragHandler from './core/drag-handler.js';
import SnapEngine from './core/snap-engine.js';
import BlockManager from './core/block-manager.js';
import DomUtils from './utils/dom-utils.js';

// 主函数保持API兼容
var flowy = function(canvas, grab, release, snapping, spacing_x, spacing_y) {
    // 初始化各个模块
    // 保持完全相同的对外行为
};
```

## 🧪 测试策略

### 每个阶段的测试检查点

#### 模块提取后验证
```bash
# 1. 单元测试
npm run test:unit
# 期望: 83/83 测试通过

# 2. 端到端测试
npm run test:e2e
# 期望: 所有E2E测试通过

# 3. 代码覆盖率
npm run test:coverage
# 期望: 覆盖率不降低

# 4. 性能测试
npm run test:performance
# 期望: 性能不降级
```

#### 回滚条件
如果任何测试失败：
1. 立即停止重构
2. 回滚到上一个稳定状态
3. 分析失败原因
4. 调整重构策略后重试

### 特殊测试关注点

#### API兼容性测试
- `flowy()` 函数调用方式不变
- `flowy.output()` 返回格式不变
- `flowy.deleteBlocks()` 行为不变
- 回调函数 (grab, release, snapping) 调用时机不变

#### 功能完整性测试
- 拖拽创建块功能
- 块的重新排列功能
- 吸附机制
- 块的删除功能
- 数据输出功能

## 🔄 风险控制

### 高风险操作
1. **事件处理重构** - 可能影响拖拽功能
2. **状态管理重构** - 可能影响块的状态同步
3. **jQuery依赖重构** - 可能影响DOM操作

### 风险缓解措施
1. **小步快跑** - 每次只重构一个小模块
2. **频繁测试** - 每个小改动后都运行测试
3. **版本控制** - 每个稳定状态都提交代码
4. **备份策略** - 保留原始文件作为备份

## 📊 成功标准

### 功能标准
- [x] 所有83个单元测试通过
- [ ] 所有端到端测试通过
- [ ] 拖拽功能完全正常
- [ ] 吸附机制完全正常
- [x] API调用完全正常

### 质量标准
- [x] 代码覆盖率 ≥ 当前水平
- [x] 性能 ≥ 当前水平
- [x] 代码可读性提升
- [x] 模块职责清晰

### 维护性标准
- [ ] 模块间依赖清晰
- [ ] 接口定义明确
- [ ] 文档更新完整
- [ ] 测试覆盖新架构

## 📅 时间估算

| 阶段 | 预估时间 | 关键活动 |
|------|----------|----------|
| 准备工作 | 1-2小时 | 基准测试、目录结构 |
| DOM工具模块 | 2-3小时 | 提取+测试验证 |
| 块管理模块 | 3-4小时 | 提取+测试验证 |
| 吸附引擎模块 | 3-4小时 | 提取+测试验证 |
| 拖拽处理模块 | 4-5小时 | 提取+测试验证 |
| API模块 | 1-2小时 | 提取+测试验证 |
| 主入口重构 | 2-3小时 | 集成+最终测试 |
| **总计** | **16-23小时** | **分2-3天完成** |

## 🚀 开始重构

准备好开始重构了吗？我们将：

1. **先运行基准测试** - 确保当前状态稳定
2. **创建第一个模块** - 从最简单的DOM工具开始
3. **逐步验证** - 每个模块都要通过所有测试
4. **保持沟通** - 每个阶段都会向你汇报进度

重构过程中，我们会严格遵循"测试先行"原则，确保功能完全不受影响。

## 📈 进度跟踪

### 已完成阶段 ✅

#### 阶段1: 准备工作 (已完成)
- ✅ 建立基准测试 (83个测试，100%通过率)
- ✅ 创建模块目录结构 (`src/core`, `src/utils`, `src/api`)
- ✅ 配置开发环境

#### 阶段2.1: DOM工具模块 (已完成)
- ✅ 创建 `src/utils/dom-utils.js`
- ✅ 封装jQuery操作接口
- ✅ 更新主文件导入
- ✅ 更新开发环境配置
- ✅ 验证所有测试通过

### 当前状态
- **当前阶段**: 准备阶段2.2 (块管理模块)
- **总体进度**: 15% (1/7个主要阶段完成)
- **测试状态**: 83/83 通过 ✅
- **风险等级**: 低 (所有验证通过)

### 下一步计划
- [ ] 阶段2.2: 块管理模块 (`src/core/block-manager.js`)
- [ ] 阶段2.3: 吸附引擎模块 (`src/core/snap-engine.js`)
- [ ] 阶段2.4: 拖拽处理模块 (`src/core/drag-handler.js`)

---

**负责人**: Augment Agent
**创建时间**: 2025-07-21
**最后更新**: 2025-07-21
**预计完成**: 2-3个工作日

!function(){"use strict";const e=function(t,i,l,o,r,n){function d(e){o(e)}i||(i=function(){}),l||(l=function(){}),o||(o=function(){}),r||(r=20),n||(n=80),$(document).ready(function(){const o=function(){if("undefined"!=typeof window&&window.BlockManager)return new window.BlockManager;if("undefined"!=typeof require)try{return new(require("./core/block-manager.js"))}catch(e){return null}return null}();let f=o?o.getAllBlocks():[],a=o?o.getTempBlocks():[];const s=t;function c(){o&&(f=o.getAllBlocks(),a=o.getTempBlocks())}function p(){return o?o.getBlockCount():f.length}function h(e){o?o.addBlock(e):f.push(e)}function u(){o?(o.mergeTempBlocks(),f=o.getAllBlocks(),a=o.getTempBlocks()):(f=$.merge(f,a),a=[])}function v(e){o?(o.removeBlocks(function(t){return t.id!=e}),f=o.getAllBlocks()):f=$.grep(f,function(t){return t.id!=e})}let g=!1;const w=r,k=n;let x,b,m,y,C=0,L=0,T=!1,B=!1;function I(){C=f.map(e=>e.x);const e=f.map(e=>e.width),t=C.map(function(t,i){return t-e[i]/2});if(C=Math.min.apply(Math,t),C<s.offset().left){B=!0;const e=f.map(e=>e.id);for(var i=0;i<f.length;i++)if($(".blockid[value="+f.filter(t=>t.id==e[i])[0].id+"]").parent().css("left",f.filter(t=>t.id==e[i])[0].x-f.filter(t=>t.id==e[i])[0].width/2-C+20),-1!=f.filter(t=>t.id==e[i])[0].parent){const t=f.filter(t=>t.id==e[i])[0];t.x-f.filter(t=>t.id==f.filter(t=>t.id==e[i])[0].parent)[0].x<0?$(".arrowid[value="+e[i]+"]").parent().css("left",t.x-C+20-5+"px"):$(".arrowid[value="+e[i]+"]").parent().css("left",f.filter(t=>t.id==f.filter(t=>t.id==e[i])[0].parent)[0].x-20-C+20+"px")}for(i=0;i<f.length;i++)f[i].x=$(".blockid[value="+f[i].id+"]").parent().offset().left+s.offset().left-$(".blockid[value="+f[i].id+"]").parent().innerWidth()/2-40;L=C}}function M(){const e=f.map(e=>e.parent);for(var t=0;t<e.length;t++){if(-1==e[t])continue;let o=0,r=0;for(var i=0;i<f.filter(i=>i.parent==e[t]).length;i++){var l=f.filter(i=>i.parent==e[t])[i];0==f.filter(e=>e.parent==l.id).length&&(l.childwidth=0),l.childwidth>l.width?i==f.filter(i=>i.parent==e[t]).length-1?o+=l.childwidth:o+=l.childwidth+w:i==f.filter(i=>i.parent==e[t]).length-1?o+=l.width:o+=l.width+w}if(-1!=e[t]){const i=f.filter(i=>i.id==e[t])[0];i&&(i.childwidth=o)}for(i=0;i<f.filter(i=>i.parent==e[t]).length;i++){l=f.filter(i=>i.parent==e[t])[i];if(-1!=e[t]){const i=f.filter(i=>i.id==e[t])[0];if(i){const e=i.y;$(".blockid[value="+l.id+"]").parent().css("top",i.y+k+"px"),i.y=i.y+k,i.originalY=e}}l.childwidth>l.width?($(".blockid[value="+l.id+"]").parent().css("left",f.filter(i=>i.id==e[t])[0].x-o/2+r+l.childwidth/2-l.width/2-s.offset().left+"px"),l.x=f.filter(i=>i.id==e[t])[0].x-o/2+r+l.childwidth/2,r+=l.childwidth+w):($(".blockid[value="+l.id+"]").parent().css("left",f.filter(i=>i.id==e[t])[0].x-o/2+r-s.offset().left+"px"),l.x=f.filter(i=>i.id==e[t])[0].x-o/2+r+l.width/2,r+=l.width+w);const n=f.filter(e=>e.id==l.id)[0],d=n.x-f.filter(e=>e.id==l.parent)[0].x+20,a=f.filter(e=>e.id==l.parent)[0],c=void 0!==a.originalY?a.originalY:a.y,p=n.y-n.height/2-(c+a.height/2);$(".arrowid[value="+l.id+"]").parent().css("top",f.filter(e=>e.id==l.parent)[0].y+f.filter(e=>e.id==l.parent)[0].height/2-s.offset().top+"px"),d<0?($(".arrowid[value="+l.id+"]").parent().css("left",n.x-5-s.offset().left+"px"),$(".arrowid[value="+l.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+l.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(f.filter(e=>e.id==l.parent)[0].x-n.x+5)+" 0L"+(f.filter(e=>e.id==l.parent)[0].x-n.x+5)+" "+k/2+"L5 "+k/2+"L5 "+p+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(p-5)+"H10L5 "+p+"L0 "+(p-5)+'Z" fill="#C5CCD0"/></svg>')):($(".arrowid[value="+l.id+"]").parent().css("left",f.filter(e=>e.id==l.parent)[0].x-20-s.offset().left+"px"),$(".arrowid[value="+l.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+l.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+k/2+"L"+d+" "+k/2+"L"+d+" "+p+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(d-5)+" "+(p-5)+"H"+(d+5)+"L"+d+" "+p+"L"+(d-5)+" "+(p-5)+'Z" fill="#C5CCD0"/></svg>'))}}}s&&"function"==typeof s.append&&s.append("<div class='indicator invisible'></div>"),e.output=function(){const e=[];if(f.length>0){for(var t=0;t<f.length;t++)e.push({id:f[t].id,parent:f[t].parent,data:[]}),$(".blockid[value="+f[t].id+"]").parent().children("input").each(function(){const i=$(this).attr("name"),l=$(this).val();e[t].data.push({name:i,value:l})});return e}},e.deleteBlocks=function(){o?(o.clearBlocks(),f.length=0):f=[],s.html("<div class='indicator invisible'></div>")},$(document).on("mousedown",".create-flowy",function(e){if(1===e.which){if(y=$(this),0==p()){var t=p();$(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+t+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),x=$(".blockid[value="+t+"]").parent()}else{t=o?o.getNextBlockId():0===f.length?0:Math.max.apply(Math,f.map(e=>e.id))+1;$(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+t+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),x=$(".blockid[value="+parseInt(t)+"]").parent()}l=$(this),i(l),x.addClass("dragging"),g=!0,b=e.clientX-$(this).offset().left,m=e.clientY-$(this).offset().top,x.css("left",e.clientX-b+"px"),x.css("top",e.clientY-m+"px")}var l}),$(document).on("mouseup",function(e){if(1===e.which&&(g||T))if(l(),$(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"),g&&(y.removeClass("dragnow"),x.removeClass("dragging")),0==parseInt(x.children(".blockid").val())&&T){x.removeClass("dragging"),T=!1;for(var t=0;t<a.length;t++)a[t].id!=parseInt(x.children(".blockid").val())&&($(".blockid[value="+a[t].id+"]").parent().css("left",$(".blockid[value="+a[t].id+"]").parent().offset().left-s.offset().left+s.scrollLeft()),$(".blockid[value="+a[t].id+"]").parent().css("top",$(".blockid[value="+a[t].id+"]").parent().offset().top-s.offset().top+s.scrollTop()),$(".arrowid[value="+a[t].id+"]").parent().css("left",$(".arrowid[value="+a[t].id+"]").parent().offset().left-s.offset().left+s.scrollLeft()),$(".arrowid[value="+a[t].id+"]").parent().css("top",$(".arrowid[value="+a[t].id+"]").parent().offset().top-s.offset().top+s.scrollTop()+"px"),$(".blockid[value="+a[t].id+"]").parent().appendTo(s),$(".arrowid[value="+a[t].id+"]").parent().appendTo(s),a[t].x=$(".blockid[value="+a[t].id+"]").parent().offset().left+$(".blockid[value="+a[t].id+"]").innerWidth()/2+s.scrollLeft(),a[t].y=$(".blockid[value="+a[t].id+"]").parent().offset().top+$(".blockid[value="+a[t].id+"]").parent().innerHeight()/2+s.scrollTop());a.filter(e=>0==e.id)[0].x=x.offset().left+x.innerWidth()/2,a.filter(e=>0==e.id)[0].y=x.offset().top+x.innerHeight()/2,u()}else if(g&&0==f.length&&x.offset().top>s.offset().top&&x.offset().left>s.offset().left)d(x),g=!1,x.css("top",x.offset().top-s.offset().top+s.scrollTop()+"px"),x.css("left",x.offset().left-s.offset().left+s.scrollLeft()+"px"),x.appendTo(s),h({parent:-1,childwidth:0,id:parseInt(x.children(".blockid").val()),x:x.offset().left+x.innerWidth()/2+s.scrollLeft(),y:x.offset().top+x.innerHeight()/2+s.scrollTop(),width:x.innerWidth(),height:x.innerHeight()});else if(g&&0==f.length)x.remove();else if(g||T){const e=x.offset().left+x.innerWidth()/2+s.scrollLeft(),l=x.offset().top+s.scrollTop(),n=f.map(e=>e.id),p={dragPos:{x:e,y:l},blocks:f.map(e=>({id:e.id,x:e.x,y:e.y,width:e.width,height:e.height})),dragElement:{offsetLeft:x.offset().left,offsetTop:x.offset().top,width:x.innerWidth(),height:x.innerHeight()}};window.lastDebugInfo=p,console.log("Âê∏ÈôÑÊ£ÄÊµã:",p);for(var i=0;i<f.length;i++){const p=f.filter(e=>e.id==n[i])[0],v=p.x-p.width/2-w,b=p.x+p.width/2+w,m=p.y-p.height/2,y=p.y+p.height,C=e>=v&&e<=b,L=l>=m&&l<=y,B={blockId:n[i],targetBlock:{x:p.x,y:p.y,width:p.width,height:p.height},dragPos:{x:e,y:l},xRange:{min:v,max:b,inRange:C},yRange:{min:m,max:y,inRange:L},shouldSnap:C&&L,paddingx:w};if(window.lastSnapCheck=B,console.log("Âê∏ÈôÑÊù°‰ª∂Ê£ÄÊü•:",B),C&&L){console.log("üéØ Âê∏ÈôÑÊù°‰ª∂Êª°Ë∂≥ÔºåÂºÄÂßãÊâßË°åÂê∏ÈôÑÈÄªËæë",{rearrange:T}),g=!1,T?console.log("üîÑ ÈáçÊéíÊ®°ÂºèÔºåË∑≥ËøáblockSnap"):(console.log("üìå ÊâßË°åblockSnapÂíåappendTo"),d(x),x.appendTo(s));let e=0,l=0;for(t=0;t<f.filter(e=>e.parent==n[i]).length;t++){(r=f.filter(e=>e.parent==n[i])[t]).childwidth>r.width?e+=r.childwidth+w:e+=r.width+w}e+=x.innerWidth();for(t=0;t<f.filter(e=>e.parent==n[i]).length;t++){(r=f.filter(e=>e.parent==n[i])[t]).childwidth>r.width?($(".blockid[value="+r.id+"]").parent().css("left",f.filter(e=>e.id==n[i])[0].x-e/2+l+r.childwidth/2-r.width/2+"px"),r.x=f.filter(e=>e.parent==n[i])[0].x-e/2+l+r.childwidth/2,l+=r.childwidth+w):($(".blockid[value="+r.id+"]").parent().css("left",f.filter(e=>e.id==n[i])[0].x-e/2+l+"px"),r.x=f.filter(e=>e.parent==n[i])[0].x-e/2+l+r.width/2,l+=r.width+w)}if(x.css("left",f.filter(e=>e.id==n[i])[0].x-e/2+l-s.offset().left+s.scrollLeft()+"px"),x.css("top",f.filter(e=>e.id==n[i])[0].y+f.filter(e=>e.id==n[i])[0].height/2+k-s.offset().top+"px"),T){a.filter(e=>e.id==parseInt(x.children(".blockid").val()))[0].x=x.offset().left+x.innerWidth()/2+s.scrollLeft(),a.filter(e=>e.id==parseInt(x.children(".blockid").val()))[0].y=x.offset().top+x.innerHeight()/2+s.scrollTop(),a.filter(e=>e.id==x.children(".blockid").val())[0].parent=n[i];for(t=0;t<a.length;t++)a[t].id!=parseInt(x.children(".blockid").val())&&($(".blockid[value="+a[t].id+"]").parent().css("left",$(".blockid[value="+a[t].id+"]").parent().offset().left-s.offset().left+s.scrollLeft()),$(".blockid[value="+a[t].id+"]").parent().css("top",$(".blockid[value="+a[t].id+"]").parent().offset().top-s.offset().top+s.scrollTop()),$(".arrowid[value="+a[t].id+"]").parent().css("left",$(".arrowid[value="+a[t].id+"]").parent().offset().left-s.offset().left+s.scrollLeft()+20),$(".arrowid[value="+a[t].id+"]").parent().css("top",$(".arrowid[value="+a[t].id+"]").parent().offset().top-s.offset().top+s.scrollTop()),$(".blockid[value="+a[t].id+"]").parent().appendTo(s),$(".arrowid[value="+a[t].id+"]").parent().appendTo(s),a[t].x=$(".blockid[value="+a[t].id+"]").parent().offset().left+$(".blockid[value="+a[t].id+"]").innerWidth()/2+s.scrollLeft(),a[t].y=$(".blockid[value="+a[t].id+"]").parent().offset().top+$(".blockid[value="+a[t].id+"]").parent().innerHeight()/2+s.scrollTop());u()}else h({childwidth:0,parent:n[i],id:parseInt(x.children(".blockid").val()),x:x.offset().left+x.innerWidth()/2+s.scrollLeft(),y:x.offset().top+x.innerHeight()/2+s.scrollTop(),width:x.innerWidth(),height:x.innerHeight()}),c();c();const p=f.filter(e=>e.id==parseInt(x.children(".blockid").val()))[0],v=p.x-f.filter(e=>e.id==n[i])[0].x+20,b=f.filter(e=>e.parent==n[i])[0],m=p.y-p.height/2-(b?b.y+b.height/2:p.y+p.height/2)+s.scrollTop();if(v<0)x.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+x.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(f.filter(e=>e.id==n[i])[0].x-p.x+5)+" 0L"+(f.filter(e=>e.id==n[i])[0].x-p.x+5)+" "+k/2+"L5 "+k/2+"L5 "+m+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(m-5)+"H10L5 "+m+"L0 "+(m-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+x.children(".blockid").val()+"]").parent().css("left",p.x-5-s.offset().left+s.scrollLeft()+"px"),$(".arrowid[value="+x.children(".blockid").val()+"]").parent().css("top",f.filter(e=>e.id==n[i])[0].y+f.filter(e=>e.id==n[i])[0].height/2-s.offset().top+s.scrollTop()+"px");else{const e=`M20 0L20 ${k/2}L${v} ${k/2}L${v} ${m}`;x.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+x.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="'+e+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(v-5)+" "+(m-5)+"H"+(v+5)+"L"+v+" "+m+"L"+(v-5)+" "+(m-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+parseInt(x.children(".blockid").val())+"]").parent().css("left",f.filter(e=>e.id==n[i])[0].x-20-s.offset().left+s.scrollLeft()+"px")}if($(".arrowid[value="+parseInt(x.children(".blockid").val())+"]").parent().css("top",f.filter(e=>e.id==n[i])[0].y+f.filter(e=>e.id==n[i])[0].height/2-s.offset().top+s.scrollTop()+"px"),-1!=f.filter(e=>e.id==n[i])[0].parent){let l=!1;for(var o=n[i];!l;)if(-1==f.filter(e=>e.id==o)[0].parent)l=!0;else{let e=0;for(t=0;t<f.filter(e=>e.parent==o).length;t++){var r;(r=f.filter(e=>e.parent==o)[t]).childwidth>r.width?t==f.filter(e=>e.parent==o).length-1?e+=r.childwidth:e+=r.childwidth+w:t==f.filter(e=>e.parent==o).length-1?e+=r.width:e+=r.width+w}f.filter(e=>e.id==o)[0].childwidth=e,o=f.filter(e=>e.id==o)[0].parent}f.filter(e=>e.id==o)[0].childwidth=e}T&&(T=!1,x.removeClass("dragging")),M(),I();break}i==f.length-1&&(T&&(T=!1,a=[]),g=!1,x.remove())}}}),$(document).on("mousedown",".block",function(e){$(document).on("mouseup mousemove",".block",function e(t){if("mouseup"!==t.type&&1===t.which&&!g&&!T){T=!0,x=$(this),x.addClass("dragging"),b=t.clientX-$(this).offset().left,m=t.clientY-$(this).offset().top;const e=parseInt($(this).children(".blockid").val());x=$(this),a.push(f.filter(t=>t.id==e)[0]),f=$.grep(f,function(t){return t.id!=e}),$(".arrowid[value="+e+"]").parent().remove();let l=f.filter(t=>t.parent==e),o=!1,r=[];const n=[];for(;!o;){for(var i=0;i<l.length;i++)a.push(f.filter(e=>e.id==l[i].id)[0]),$(".blockid[value="+l[i].id+"]").parent().css("left",$(".blockid[value="+l[i].id+"]").parent().offset().left-x.offset().left),$(".blockid[value="+l[i].id+"]").parent().css("top",$(".blockid[value="+l[i].id+"]").parent().offset().top-x.offset().top),$(".arrowid[value="+l[i].id+"]").parent().css("left",$(".arrowid[value="+l[i].id+"]").parent().offset().left-x.offset().left),$(".arrowid[value="+l[i].id+"]").parent().css("top",$(".arrowid[value="+l[i].id+"]").parent().offset().top-x.offset().top),$(".blockid[value="+l[i].id+"]").parent().appendTo(x),$(".arrowid[value="+l[i].id+"]").parent().appendTo(x),r.push(l[i].id),n.push(l[i].id);0==r.length?o=!0:(l=f.filter(e=>r.includes(e.parent)),r=[])}for(i=0;i<f.filter(t=>t.parent==e).length;i++){v(f.filter(t=>t.parent==e)[i])}for(i=0;i<n.length;i++){v(n[i])}f.length>1&&M(),B&&function(){if(L<s.offset().left){B=!1;const t=f.map(e=>e.id);for(var e=0;e<f.length;e++)if($(".blockid[value="+f.filter(i=>i.id==t[e])[0].id+"]").parent().css("left",f.filter(i=>i.id==t[e])[0].x-f.filter(i=>i.id==t[e])[0].width/2-L-20),f.filter(i=>i.id==t[e])[0].x=$(".blockid[value="+f.filter(i=>i.id==t[e])[0].id+"]").parent().offset().left+f.filter(i=>i.id==t[e])[0].width/2,-1!=f.filter(i=>i.id==t[e])[0].parent){const i=f.filter(i=>i.id==t[e])[0];i.x-f.filter(i=>i.id==f.filter(i=>i.id==t[e])[0].parent)[0].x<0?$(".arrowid[value="+t[e]+"]").parent().css("left",i.x-5-s.offset().left+"px"):$(".arrowid[value="+t[e]+"]").parent().css("left",f.filter(i=>i.id==f.filter(i=>i.id==t[e])[0].parent)[0].x-20-s.offset().left+"px")}for(e=0;e<f.length;e++);L=0}}()}$(document).off("mouseup mousemove",e)})}),$(document).on("mousemove",function(e){if(g?(x.css("left",e.clientX-b+"px"),x.css("top",e.clientY-m+"px")):T&&(x.css("left",e.clientX-b-s.offset().left+s.scrollLeft()+"px"),x.css("top",e.clientY-m-s.offset().top+s.scrollTop()+"px"),a.filter(e=>e.id==parseInt(x.children(".blockid").val())).x=x.offset().left+x.innerWidth()/2+s.scrollLeft(),a.filter(e=>e.id==parseInt(x.children(".blockid").val())).y=x.offset().top+x.innerHeight()/2+s.scrollTop()),g||T){const e=x.offset().left+x.innerWidth()/2+s.scrollLeft(),i=x.offset().top+s.scrollTop(),l=f.map(e=>e.id);for(var t=0;t<f.length;t++){if(e>=f.filter(e=>e.id==l[t])[0].x-f.filter(e=>e.id==l[t])[0].width/2-w&&e<=f.filter(e=>e.id==l[t])[0].x+f.filter(e=>e.id==l[t])[0].width/2+w&&i>=f.filter(e=>e.id==l[t])[0].y-f.filter(e=>e.id==l[t])[0].height/2&&i<=f.filter(e=>e.id==l[t])[0].y+f.filter(e=>e.id==l[t])[0].height){$(".indicator").appendTo($(".blockid[value="+l[t]+"]").parent()),$(".indicator").css("left",$(".blockid[value="+l[t]+"]").parent().innerWidth()/2-5+"px"),$(".indicator").css("top",$(".blockid[value="+l[t]+"]").parent().innerHeight()+"px"),$(".indicator").removeClass("invisible");break}t==f.length-1&&($(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"))}}})}),window.clearFlowyCanvas=function(){$(".block").remove(),$(".arrowblock").remove(),$(".indicator").addClass("invisible"),active=!1,rearrange=!1,drag=null,original=null,blockManager?blockManager.clearAll():(blocks.length=0,blockstemp.length=0),syncBlockReferences()}};"undefined"!=typeof module&&module.exports?module.exports=e:"undefined"!=typeof window&&(window.flowy=e)}();
//# sourceMappingURL=flowy.iife.js.map
